---
layout: post
exclude: true
title: How to setup & configure CAS with Database
date: '2014-12-08T23:05:00.002+05:30'
author: Ekansh Rastogi
tags:
- CAS
- Authentication
modified_time: '2014-12-10T14:32:16.729+05:30'
blogger_id: tag:blogger.com,1999:blog-5485242750509374114.post-1276278210951267152
blogger_orig_url: http://ekiras.blogspot.com/2014/12/how-to-setup-and-configure-cas-with-database.html
redirect_from: "/2014/12/how-to-setup-and-configure-cas-with-database.html"
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div dir="ltr" style="text-align: left;" trbidi="on"><div dir="ltr" style="text-align: left;" trbidi="on"><div class="hl-note"><b>Points To Remember</b></div><ul style="text-align: left;"><li>You can user MYSQL, Oracle or PostgreSQL connectors as the database.</li><li>Make sure you have created a SSL certificate to run the CAS server on browser.</li></ul><h2 style="text-align: left;">Step 1: Adding Dependencies in pom.xml</h2>Add the following dependencies to the pom.xml that we created in <a href="http://ekiras.blogspot.in/2014/12/how-to-setup-and-configure-cas-central-authentication-service.html" target="_blank">this tutorial.</a>&nbsp;These are the dependencies that are required to authenticate the user using the database.<br /><pre class="brush : xml"> &lt;dependency&gt;<br />            &lt;groupId&gt;org.jasig.cas&lt;/groupId&gt;<br />            &lt;artifactId&gt;cas-server-support-generic&lt;/artifactId&gt;<br />            &lt;version&gt;${cas.version}&lt;/version&gt;<br />            &lt;type&gt;jar&lt;/type&gt;<br />            &lt;scope&gt;runtime&lt;/scope&gt;<br />        &lt;/dependency&gt;<br /> &lt;dependency&gt;<br />            &lt;groupId&gt;org.jasig.cas&lt;/groupId&gt;<br />            &lt;artifactId&gt;cas-server-support-jdbc&lt;/artifactId&gt;<br />            &lt;version&gt;${cas.version}&lt;/version&gt;<br />     &lt;/dependency&gt;<br />     &lt;dependency&gt;<br />         &lt;groupId&gt;c3p0&lt;/groupId&gt;<br />         &lt;artifactId&gt;c3p0&lt;/artifactId&gt;<br />           &lt;version&gt;0.9.1.2&lt;/version&gt;<br />     &lt;/dependency&gt;<br /> &lt;dependency&gt;<br />     &lt;groupId&gt;org.jasig.cas&lt;/groupId&gt;<br />     &lt;artifactId&gt;cas-server-integration-restlet&lt;/artifactId&gt;<br />     &lt;version&gt;${cas.version}&lt;/version&gt;<br />     &lt;type&gt;jar&lt;/type&gt;<br /> &lt;/dependency&gt;<br /></pre>So now the pom.xml will look like the following<br /><pre class="brush : xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;project xmlns="http://maven.apache.org/POM/4.0.0"<br />         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br />         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd "&gt;<br />    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;<br />    &lt;groupId&gt;cas&lt;/groupId&gt;<br />    &lt;artifactId&gt;ekiras&lt;/artifactId&gt;<br />    &lt;packaging&gt;war&lt;/packaging&gt;<br />    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;<br /> <br />    &lt;build&gt;<br />        &lt;plugins&gt;<br />            &lt;plugin&gt;<br />                 &lt;artifactId&gt;maven-war-plugin&lt;/artifactId&gt;<br />                             &lt;configuration&gt;<br />                                 &lt;warName&gt;cas&lt;/warName&gt;<br />                             &lt;/configuration&gt;<br />                        &lt;/plugin&gt;<br />        &lt;/plugins&gt;<br />    &lt;/build&gt;<br /> <br />    &lt;dependencies&gt;<br />        &lt;dependency&gt;<br />            &lt;groupId&gt;org.jasig.cas&lt;/groupId&gt;<br />            &lt;artifactId&gt;cas-server-webapp&lt;/artifactId&gt;<br />            &lt;version&gt;${cas.version}&lt;/version&gt;<br />            &lt;type&gt;war&lt;/type&gt;<br />            &lt;scope&gt;runtime&lt;/scope&gt;<br />        &lt;/dependency&gt;<br /> &lt;dependency&gt;<br />            &lt;groupId&gt;org.jasig.cas&lt;/groupId&gt;<br />            &lt;artifactId&gt;cas-server-support-generic&lt;/artifactId&gt;<br />            &lt;version&gt;${cas.version}&lt;/version&gt;<br />            &lt;type&gt;jar&lt;/type&gt;<br />            &lt;scope&gt;runtime&lt;/scope&gt;<br />        &lt;/dependency&gt;<br /> &lt;dependency&gt;<br />            &lt;groupId&gt;org.jasig.cas&lt;/groupId&gt;<br />            &lt;artifactId&gt;cas-server-support-jdbc&lt;/artifactId&gt;<br />            &lt;version&gt;${cas.version}&lt;/version&gt;<br />     &lt;/dependency&gt;<br />     &lt;dependency&gt;<br />         &lt;groupId&gt;c3p0&lt;/groupId&gt;<br />         &lt;artifactId&gt;c3p0&lt;/artifactId&gt;<br />           &lt;version&gt;0.9.1.2&lt;/version&gt;<br />     &lt;/dependency&gt;<br /> &lt;dependency&gt;<br />     &lt;groupId&gt;org.jasig.cas&lt;/groupId&gt;<br />     &lt;artifactId&gt;cas-server-integration-restlet&lt;/artifactId&gt;<br />     &lt;version&gt;${cas.version}&lt;/version&gt;<br />     &lt;type&gt;jar&lt;/type&gt;<br /> &lt;/dependency&gt;<br /> &lt;dependency&gt;<br />   &lt;groupId&gt;mysql&lt;/groupId&gt;<br />   &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;<br />   &lt;version&gt;5.1.34&lt;/version&gt;<br /> &lt;/dependency&gt;<br />    &lt;/dependencies&gt;<br /> <br />    &lt;properties&gt;<br />        &lt;cas.version&gt;4.0.0&lt;/cas.version&gt;<br />    &lt;/properties&gt;<br /> <br />        &lt;repositories&gt;<br />             &lt;repository&gt;<br />                  &lt;id&gt;ja-sig&lt;/id&gt;<br />                  &lt;url&gt;http://oss.sonatype.org/content/repositories/releases/ &lt;/url&gt;<br />             &lt;/repository&gt;<br />        &lt;/repositories&gt;<br />&lt;/project&gt;<br /></pre><div class="hl-note"><b>Step 2: Configuring the deployerConfigContext.xml</b></div>Create folder <b>/src/main/webapp/WEB-INF&nbsp;</b>in the directory <b>PROJECT.</b>&nbsp;Now create a file named <b>deployerConfigContext.xml</b>&nbsp;in this folder location. and add the following configurations.<br /><pre class="brush : xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;!--<br /><br />    Licensed to Jasig under one or more contributor license<br />    agreements. See the NOTICE file distributed with this work<br />    for additional information regarding copyright ownership.<br />    Jasig licenses this file to you under the Apache License,<br />    Version 2.0 (the "License"); you may not use this file<br />    except in compliance with the License.  You may obtain a<br />    copy of the License at the following location:<br /><br />      http://www.apache.org/licenses/LICENSE-2.0<br /><br />    Unless required by applicable law or agreed to in writing,<br />    software distributed under the License is distributed on an<br />    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY<br />    KIND, either express or implied.  See the License for the<br />    specific language governing permissions and limitations<br />    under the License.<br /><br />--&gt;<br />&lt;!--<br />| deployerConfigContext.xml centralizes into one file some of the declarative configuration that<br />| all CAS deployers will need to modify.<br />|<br />| This file declares some of the Spring-managed JavaBeans that make up a CAS deployment.  <br />| The beans declared in this file are instantiated at context initialization time by the Spring <br />| ContextLoaderListener declared in web.xml.  It finds this file because this<br />| file is among those declared in the context parameter "contextConfigLocation".<br />|<br />| By far the most common change you will need to make in this file is to change the last bean<br />| declaration to replace the default authentication handler with<br />| one implementing your approach for authenticating usernames and passwords.<br />+--&gt;<br /><br />&lt;beans xmlns="http://www.springframework.org/schema/beans"<br />       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br />       xmlns:p="http://www.springframework.org/schema/p"<br />       xmlns:c="http://www.springframework.org/schema/c"<br />       xmlns:tx="http://www.springframework.org/schema/tx"<br />       xmlns:util="http://www.springframework.org/schema/util"<br />       xmlns:sec="http://www.springframework.org/schema/security"<br />       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.2.xsd<br />       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.2.xsd<br />       http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.2.xsd<br />       http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"&gt;<br /><br />    &lt;!--<br />       | The authentication manager defines security policy for authentication by specifying at a minimum<br />       | the authentication handlers that will be used to authenticate credential. While the AuthenticationManager<br />       | interface supports plugging in another implementation, the default PolicyBasedAuthenticationManager should<br />       | be sufficient in most cases.<br />       +--&gt;<br />    &lt;bean id="authenticationManager" class="org.jasig.cas.authentication.PolicyBasedAuthenticationManager"&gt;<br />        &lt;constructor-arg&gt;<br />            &lt;map&gt;<br />                &lt;!--<br />                   | IMPORTANT<br />                   | Every handler requires a unique name.<br />                   | If more than one instance of the same handler class is configured, you must explicitly<br />                   | set its name to something other than its default name (typically the simple class name).<br />                   --&gt;<br />                &lt;entry key-ref="proxyAuthenticationHandler" value-ref="proxyPrincipalResolver" /&gt;<br />                &lt;!--entry key-ref="primaryAuthenticationHandler" value-ref="primaryPrincipalResolver" /--&gt;<br />  &lt;entry key-ref="SearchModeSearchDatabaseAuthenticationHandler" value-ref="proxyPrincipalResolver" /&gt;<br />            &lt;/map&gt;<br />        &lt;/constructor-arg&gt;<br /><br />        &lt;!-- Uncomment the metadata populator to allow clearpass to capture and cache the password<br />             This switch effectively will turn on clearpass.<br />        &lt;property name="authenticationMetaDataPopulators"&gt;<br />           &lt;util:list&gt;<br />              &lt;bean class="org.jasig.cas.extension.clearpass.CacheCredentialsMetaDataPopulator"<br />                    c:credentialCache-ref="encryptedMap" /&gt;<br />           &lt;/util:list&gt;<br />        &lt;/property&gt;<br />        --&gt;<br /><br />        &lt;!--<br />           | Defines the security policy around authentication. Some alternative policies that ship with CAS:<br />           |<br />           | * NotPreventedAuthenticationPolicy - all credential must either pass or fail authentication<br />           | * AllAuthenticationPolicy - all presented credential must be authenticated successfully<br />           | * RequiredHandlerAuthenticationPolicy - specifies a handler that must authenticate its credential to pass<br />           --&gt;<br />        &lt;property name="authenticationPolicy"&gt;<br />            &lt;bean class="org.jasig.cas.authentication.AnyAuthenticationPolicy" /&gt;<br />        &lt;/property&gt;<br />    &lt;/bean&gt;<br /><br />    &lt;!-- Required for proxy ticket mechanism. --&gt;<br />    &lt;bean id="proxyAuthenticationHandler"<br />          class="org.jasig.cas.authentication.handler.support.HttpBasedServiceCredentialsAuthenticationHandler"<br />          p:httpClient-ref="httpClient" /&gt;<br /><br />    &lt;!--<br />       | TODO: Replace this component with one suitable for your enviroment.<br />       |<br />       | This component provides authentication for the kind of credential used in your environment. In most cases<br />       | credential is a username/password pair that lives in a system of record like an LDAP directory.<br />       | The most common authentication handler beans:<br />       |<br />       | * org.jasig.cas.authentication.LdapAuthenticationHandler<br />       | * org.jasig.cas.adaptors.jdbc.QueryDatabaseAuthenticationHandler<br />       | * org.jasig.cas.adaptors.x509.authentication.handler.support.X509CredentialsAuthenticationHandler<br />       | * org.jasig.cas.support.spnego.authentication.handler.support.JCIFSSpnegoAuthenticationHandler<br />       --&gt;<br /><br />&lt;!-- Authentication method start--&gt;<br /><br />&lt;bean id="dataSource"<br />  class="com.mchange.v2.c3p0.ComboPooledDataSource"<br />  p:driverClass="com.mysql.jdbc.Driver"<br />  p:jdbcUrl="jdbc:mysql://localhost:3306/cas"<br />  p:user="username"<br />  p:password="password" /&gt;<br /><br />&lt;!-- Authentication method end--&gt;<br />&lt;bean id="passwordEncoder"<br />      class="org.jasig.cas.authentication.handler.DefaultPasswordEncoder"<br />      c:encodingAlgorithm="MD5"<br />      p:characterEncoding="UTF-8" /&gt;<br /><br />&lt;bean id="SearchModeSearchDatabaseAuthenticationHandler"<br />      class="org.jasig.cas.adaptors.jdbc.SearchModeSearchDatabaseAuthenticationHandler"<br />      p:dataSource-ref="dataSource"<br />      p:passwordEncoder-ref="passwordEncoder"<br />      p:tableUsers="user"<br />      p:fieldUser="email"<br />      p:fieldPassword="password" /&gt;<br /><br />    &lt;!-- Required for proxy ticket mechanism --&gt;<br />    &lt;bean id="proxyPrincipalResolver"<br />          class="org.jasig.cas.authentication.principal.BasicPrincipalResolver" /&gt;<br /><br />    &lt;!--<br />       | Resolves a principal from a credential using an attribute repository that is configured to resolve<br />       | against a deployer-specific store (e.g. LDAP).<br />       --&gt;<br />    &lt;bean id="primaryPrincipalResolver"<br />          class="org.jasig.cas.authentication.principal.PersonDirectoryPrincipalResolver" &gt;<br />        &lt;property name="attributeRepository" ref="attributeRepository" /&gt;<br />    &lt;/bean&gt;<br /><br />    &lt;!--<br />    Bean that defines the attributes that a service may return.  This example uses the Stub/Mock version.  A real implementation<br />    may go against a database or LDAP server.  The id should remain "attributeRepository" though.<br />    +--&gt;<br />    &lt;bean id="attributeRepository" class="org.jasig.services.persondir.support.StubPersonAttributeDao"<br />            p:backingMap-ref="attrRepoBackingMap" /&gt;<br />    <br />    &lt;util:map id="attrRepoBackingMap"&gt;<br />        &lt;entry key="uid" value="uid" /&gt;<br />        &lt;entry key="eduPersonAffiliation" value="eduPersonAffiliation" /&gt; <br />        &lt;entry key="groupMembership" value="groupMembership" /&gt;<br />    &lt;/util:map&gt;<br /><br />    &lt;!-- <br />    Sample, in-memory data store for the ServiceRegistry. A real implementation<br />    would probably want to replace this with the JPA-backed ServiceRegistry DAO<br />    The name of this bean should remain "serviceRegistryDao".<br />    +--&gt;<br />    &lt;bean id="serviceRegistryDao" class="org.jasig.cas.services.InMemoryServiceRegistryDaoImpl"<br />            p:registeredServices-ref="registeredServicesList" /&gt;<br /><br />    &lt;util:list id="registeredServicesList"&gt;<br />            &lt;bean class="org.jasig.cas.services.RegexRegisteredService"<br />              p:id="0" p:name="HTTP and IMAP" <br />              p:description="Allows HTTP(S) and IMAP(S) protocols"<br />              p:serviceId="^(https?|imaps?)://.*" <br />              p:evaluationOrder="10000001" <br />              p:enabled="true"<br />              p:allowedToProxy="true"<br />              p:ssoEnabled="true"<br />            /&gt;<br /><br /><br />        &lt;!--<br />        Use the following definition instead of the above to further restrict access<br />        to services within your domain (including sub domains).<br />        Note that example.com must be replaced with the domain you wish to permit.<br />        This example also demonstrates the configuration of an attribute filter<br />        that only allows for attributes whose length is 3.<br />        --&gt;<br />        &lt;!--<br />        &lt;bean class="org.jasig.cas.services.RegexRegisteredService"&gt;<br />            &lt;property name="id" value="1" /&gt;<br />            &lt;property name="name" value="HTTP and IMAP on example.com" /&gt;<br />            &lt;property name="description" value="Allows HTTP(S) and IMAP(S) protocols on example.com" /&gt;<br />            &lt;property name="serviceId" value="^(https?|imaps?)://([A-Za-z0-9_-]+\.)*example\.com/.*" /&gt;<br />            &lt;property name="evaluationOrder" value="0" /&gt;<br />            &lt;property name="attributeFilter"&gt;<br />              &lt;bean class="org.jasig.cas.services.support.RegisteredServiceRegexAttributeFilter" c:regex="^\w{3}$" /&gt; <br />            &lt;/property&gt;<br />        &lt;/bean&gt;<br />        --&gt;<br />    &lt;/util:list&gt;<br />    <br />    &lt;bean id="auditTrailManager" class="com.github.inspektr.audit.support.Slf4jLoggingAuditTrailManager" /&gt;<br />    <br />    &lt;bean id="healthCheckMonitor" class="org.jasig.cas.monitor.HealthCheckMonitor" p:monitors-ref="monitorsList" /&gt;<br />  <br />    &lt;util:list id="monitorsList"&gt;<br />      &lt;bean class="org.jasig.cas.monitor.MemoryMonitor" p:freeMemoryWarnThreshold="10" /&gt;<br />      &lt;!--<br />        NOTE<br />        The following ticket registries support SessionMonitor:<br />          * DefaultTicketRegistry<br />          * JpaTicketRegistry<br />        Remove this monitor if you use an unsupported registry.<br />      --&gt;<br />      &lt;bean class="org.jasig.cas.monitor.SessionMonitor"<br />          p:ticketRegistry-ref="ticketRegistry"<br />          p:serviceTicketCountWarnThreshold="5000"<br />          p:sessionCountWarnThreshold="100000" /&gt;<br />    &lt;/util:list&gt;<br />&lt;/beans&gt;<br /></pre><br /><b>Points to be noted here</b><br /><ol style="text-align: left;"><li>We have created a&nbsp;<b>datasource</b>&nbsp;bean<br /><pre class="brush:xml">&lt;bean id="dataSource"<br />  class="com.mchange.v2.c3p0.ComboPooledDataSource"<br />  p:driverClass="com.mysql.jdbc.Driver"<br />  p:jdbcUrl="jdbc:mysql://localhost:3306/cas"<br />  p:user="username"<br />  p:password="password" /&gt;</pre>Here we can are using MYSQL database for authentication. This bean takes inputs like driver class, url, database username and password. You can add your database username password here.</li><li>We have created a password encoder here via bean that encodes the password using MD5 encrption algorithm.<br /><pre class="brush:xml">&lt;bean id="passwordEncoder"<br />      class="org.jasig.cas.authentication.handler.DefaultPasswordEncoder"<br />      c:encodingAlgorithm="MD5"<br />      p:characterEncoding="UTF-8" /&gt;</pre>You can also use other password encoding algorithms here like&nbsp;<b>SHA1.</b></li><li>We have created&nbsp;<b>SearchModeSearchDatabaseAuthenticationHandler</b>&nbsp;bean, this will actually lookup the database and authenticate the user if found.<br /><pre class="brush:xml">&lt;bean id="SearchModeSearchDatabaseAuthenticationHandler"<br />      class="org.jasig.cas.adaptors.jdbc.SearchModeSearchDatabaseAuthenticationHandler"<br />      p:dataSource-ref="dataSource"<br />      p:passwordEncoder-ref="passwordEncoder"<br />      p:tableUsers="user"<br />      p:fieldUser="email"<br />      p:fieldPassword="password" /&gt;</pre>This is the code that tells the CAS server to look for user in database via datasource that we have declared in in point 1 above. This also includes the password encoder to encode the password before checking in the database. TableUsers is the table it will look, fieldUser is the username that will be checked and fieldPassword is the password that will be looked for. Here we are making user login with email and password.</li></ol><b>Step 3: Create Dummy Table with values..</b></div><pre class="brush :sql">create table user(<br />id int  primary key auto_increment,<br />email varchar(255),<br />password varchar(255));</pre>This will create the table as<br />+-------------+----------------+-------+------+-----------+--------------------+<br />| Field &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Null &nbsp;| Key | Default | Extra &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br />+-------------+----------------+-------+------+-----------+--------------------+<br />| id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | int(11) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| NO &nbsp; &nbsp;| PRI | NULL &nbsp; &nbsp;| auto_increment |<br />| email &nbsp; &nbsp; &nbsp; &nbsp; | varchar(255) | YES | &nbsp; &nbsp; &nbsp; &nbsp;| NULL &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br />| password &nbsp;| varchar(255) | YES &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| NULL &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|<br />+-------------+----------------+--------+------+-----------+-------------------+<br />Now lets insert dummy values  <br /><pre class="brush : sql">insert into user(email,password) values('ekansh@ekiras.com','5f4dcc3b5aa765d61d8327deb882cf99')</pre>Here '5f4dcc3b5aa765d61d8327deb882cf99' is the MD5 conversion of the string password. <br /><div class="hl-note"><b>Step 4: Testing our CAS server war.</b></div>Lets create the war using the following command. <br /><pre class="brush :xml">mvn clean package</pre>Now we go and deploy the war as instructed <a href="http://ekiras.blogspot.in/2014/12/how-to-deploy-war-on-tomcat.html" target="_blank">here</a>. We will get the CAS login screen and we can enter the dummy email and password we have in database to login (email='ekansh@ekiras.com', password = 'password'). This will successfully log the user into the CAS server. <br /><div class="download"><a href="https://github.com/gitekiras/CAS-Mysql-Jdbc-Configuration.git" target="_blank">Download code from the Git Repository.</a></div><br /></div></div>